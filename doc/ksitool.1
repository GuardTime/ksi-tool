.TH KSITOOL 1



.SH NAME
.B ksitool
- Guardtime command-line tool to access KSI service.


.SH SYNOPSIS
Sign data file or hash:
.br
\fBksitool -s -f\fI file\fR |\fB -F\fI hash\fB -o\fI out.ksig\fR [\fI more options\fR]
.br

Extend signature:
.br
\fBksitool -x -i\fI sig.ksig\fB -o\fI ext.ksig\fR [\fB-T\fR] [\fI more options\fR]
.br

Download publication file:
.br
\fBksitool -p -o \fI pubfile\fB --cnstr \fIoid=value \fR... [\fI more options\fR]
.br

Create publication string:
.br
\fBksitool -p -T \fR[\fI more options]
.br

Verify signature:
.br
\fBksitool -v -i\fI sig.ksig\fB -f\fI file\fR | \fB-F\fI hash\fR [\fB -x\fR | \fB-b \fI pubfile\fR] [\fI more options\fR]
.br

Verify publication file:
.br
\fBksitool -v -b\fI pubfile\fB --cnstr \fIoid=value \fR... [\fImore options\fR]
.br
.\TODO: uncomment if implemented
.\Display current aggregation root hash value and time:
.\.br
.\.B ksitool --aggre --htime
.\.br
.\
.\Set system time from current aggregation:
.\.br
.\.B ksitool --aggre --setsystime
.\.br


.SH DESCRIPTION

This is a general signing and signature verification tool for Guardtime Keyless Signature services.


.SH OPTIONS

.TP
.B Tasks:
.\TODO: uncomment if implemented
.\.TP
.\.B --aggre
.\Use for getting root hash and time from aggregator.
.TP
.B -p
Use for downloading publication file and creating publication string.
.TP
.B -s, --sign
Use for signing document or hash.
.TP
.B -v, --verify
Use for signature and publication file verification.
.TP
.B -x, --extend
Use for online verification or signature extending.

.TP
.B Input/output:
.TP
.BI -b\  file
Use specified publication file.
.TP
.BI -f\  file
File to be signed or verified.
.TP
.BI -F\  hash
Data hash to be signed or verified. Hash format: <alg>:<hash in hex>.
.TP
.BI -H\  alg
Hash algorithm used to hash the file to be signed. Use when signing file (
.B -s -f
).
.TP
.BI -i\  file
Input signature token file to be extended or verified.
.TP
.BI -o\  file
Output file name to store signature token or publication file.
.TP
.BI --ref\  str
Publication string as base 32 encoded string. Use with 
.BR -v \. 
.TP
.BI -T\  int
.br
Specify a publication time to extend to (use with \fB-x\fR) or a time to create a new publication code for (use with \fB-p\fR) as the number of seconds since 1970-01-01 00:00:00 UTC.
.br

.TP
.B Details:
.TP
.B -d
Print detailed information.
.TP
.BI --log\  file
Dump KSI log into file.
.TP
.B -n
Print signer Name (identity).
.TP
.B --nowarn
Silence warning messages.
.br
.TP
.B -r
Print publication References (use with -vx).
.TP
.B --silent
Silence info and warning messages.
.br
.TP
.B -t
Print service Timing in ms.
.br
.TP
.B --tlv
Print signature's TLV structure.
.br

.TP
.B Configuration:
.TP
.BI -c\  int
Network transfer timeout in seconds, after successful Connect.
.TP
.BI -C\  int
Network Connect timeout in seconds (is not supported with tcp client).
.TP
.BI --cnstr\  oid=value
use OID and its expected value to verify publications file PKI signature. At least one constraint must be defined to be able to verify publications file but it is possible to define more. If value part contains spaces use " " to wrap its contents. For common OID's there are string representations: '\fBemail\fR' for 1.2.840.113549.1.9.1, '\fBcountry\fR' for 2.5.4.6, '\fBorg\fR' for 2.5.4.10 and '\fBcommon_name\fR' for 2.5.4.3. Example \fB--cnstr \fI2.5.4.6=EE \fB--cnstr \fIorg="Guardtime AS"\fR.
.TP
.BI --inc\  file
Use configuration file containing command-line parameters. Parameter must be written line by line.
.TP
.BI --pass\  str
Password for authentication.
.TP
.BI -P\  url
Specify publication file URL.
.TP
.BI -S\  url
Specify Signing service URL.
.TP
.BI --user\  str
User name for authentication.
.TP
.BI -V\  file
Use specified OpenSSL-style trust store file for publication file verification. Can have multiple values (-V <file 1> -V <file 2>).
.TP
.BI -W\  dir
Use specified OpenSSL-style trust store directory for publication file verification.
.TP
.BI -X\  url
Specify verification (eXtending) service URL.
.br

.TP
.B Help:
.TP
.B -h, --help
print ksitool help.
.br			


.SH EXIT STATUS

.TP
.B 0
Exit success. Returned if everything is OK.
.br
.TP
.B 1
Exit failure. A general failure occurred.
.br
.TP
.B 3
Invalid command-line parameter. The content or format of command-line parameter is invalid. Also a parameter may be missing.
.br
.TP
.B 4
Invalid format. Input data to KSI library is invalid, for example signature or publication file format is invalid.
.br
.TP
.B 5
Network error. Ksitool is unable to connect to the service, connection is timed out or an HTTP error was returned from the service url.
.br
.TP
.B 6
Verification error. Verification of signature or document hash failed.
.br
.TP
.B 7
Extending error. Error in extending a signature or an error was returned by extender.
.br
.TP
.B 8
Aggregation error. Error returned by aggregator.
.br	
.TP
.B 9
Input / output error. Unable to write or read file.
.br
.TP
.B 10
Cryptographic error. Error may be generated due to untrusted or unavailable hash algorithm or by an invalid PKI signature or untrusted certificate.
.br
.TP
.B 11
HMAC error. HMAC of aggregation or extend response does not match. 
.br
.TP
.B 12
No privileges. Operating system did not grant privileges to perform an operation.
.br
.TP
.B 13
System out of memory.
.br
.TP
.B 14
Authentication error. Aggregation or extending service did not accept user identification parameters.
.br


.SH EXAMPLES

In the following examples it is assumed that default service urls are defined as environment variables. Read example 1 to learn how to define service urls.

.B 1
To use ksitool, service urls must be specified. It can be done via environment variables, command-line parameters or a configuration file.

.B 1.1
To define default urls as environment variables, KSI_AGGREGATOR and KSI_EXTENDER must be defined as shown below: 

.RS
.br
.B KSI_AGGREGATOR=
.I url=http://test.com:3333/gt-signingservice pass=test_pass user=test_user
.br
.B KSI_EXTENDER=
.I url=http://test.com:8010/gt-extendingservice pass=test_pass user=test_user
.RE

.B 1.2
To define service urls on command-line or via configuration file, following parameters must be defined:
.RS

.br
.B -X
.I http://test.com:8010/gt-extendingservice
.br
.B -S
.I http://test.com:3333/gt-signingservice
.br
.B --user
.I test_user
.br
.B --pass
.I test_pass
.RE
.br

.B 1.3
To use a configuration file, parameters must be written on separate lines, into a file, as in the example above. \fI conf\fR and the configuration file must be included using option:
.br

.RS
.B --inc
.I conf  
.RE
.br



.B 2
To sign a file
.I file
and save signature to
.I sig.ksig
call:

.RS
.br
.B ksitool -s -f 
.I file
.B -o
.I sig.ksig
.RE

.B 3
To sign a data hash (hashed with SHA256) and save the resulting signature to file\fI sig.ksig\fR call:

.RS
.br
.B ksitool -s -o
.I sig.ksig
.B -F
.I SHA-256:c8ef6d57ac28d1b4e95a513959f5fcdd0688380a43d601a5ace1d2e96884690a
.RE

.B 4
To sign a data file
.I file
with non-default algorithm
.I SHA1
call:

.br
.RS
.B ksitool -s -f 
.I file 
.B -H
.I SHA1
.B -o
.I sig.ksig 
.RE

.B 5
To verify a signature
.I sig.ksig
and file
.I file
it belongs to call:

.RS
.B ksitool -v -i
.I sig.ksig
.B -f
.I file
.RE

.B 6
To verify a signature
.I sig.ksig
and hash it belongs to call:

.RS
.B ksitool -v -i
.I sig.ksig
.B -F
.I SHA-256:c8ef6d57ac28d1b4e95a513959f5fcdd0688380a43d601a5ace1d2e96884690a
.RE

.B 7
To verify a signature
.I sig.ksig
using online verification service call:

.RS
.B ksitool -vx -i
.I sig.ksig
.RE

.B 8
To extend a signature
.I sig.ksig
and save it as
.I ext.ksig
call:

.RS
.B ksitool -x -i
.I sig.ksig
.B -o
.I ext.ksig 
.RE

.B 9
To verify an extended signature
.I ext.ksig
against publication from printed media call:

.RS
.B ksitool -v -i
.I ext.ksig
.B --ref
.I AAAAAA-CT5VGY-AAPUCF-L3EKCC-NRSX56-AXIDFL-VZJQK4-WDCPOE-3KIWGB-XGPPM3-O5BIMW-REOVR4 
.RE

.B 10
To download a publication file
.I pubfile
call:

.RS
.B ksitool -p -o
.I pubfile
.RE

.B 11
To verify publication file
.I pubfile
call:

.RS
.B ksitool -v -b
.I pubfile
.RE


.SH ENVIRONMENT	

. B Default service access URL-s:

To define default URL-s, they must be defined as environment variables. For aggregator and extender service, define environment variables \fB KSI_AGGREGATOR\fR and \fBKSI_EXTENDER\fR with content\fI 'url=<url> pass=<pass> user=<user>'\fR. Only url part is mandatory: user and pass can be left undefined if anonymous access is allowed by the service. Default \fI <pass> \fR and \fI <user> \fRis \fI 'anon'\fR. 
.br

For publications file, define \fBKSI_PUBFILE\fR with content '\fIurl=<url> <constraint> <constraint> \fR...'. Constraint is formatted as  \fI<OID>="<value>"\fR where \fB""\fR can be omitted if 'value' does not contain any white-space characters. Publications file url is mandatory but constraints are not if at least one constraint is defined on command-line (see \fB--cnstr\fR).
.br

Using includes (\fB --inc\fR) or defining urls on command-line will override defaults.

.SH AUTHOR

Guardtime AS, http://www.guardtime.com/
